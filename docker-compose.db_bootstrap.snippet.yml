db_bootstrap:
  image: postgres:16
  depends_on:
    db:
      condition: service_healthy
  environment:
    POSTGRES_USER: ${POSTGRES_USER}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    POSTGRES_DB: ${POSTGRES_DB}
  networks: [app_net]
  volumes:
    - ./db/init:/docker-entrypoint-initdb.d:ro
  command: >
    bash -lc '
      set -euo pipefail;
      export PGPASSWORD="$POSTGRES_PASSWORD";
      psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d "$POSTGRES_DB"
        -f /docker-entrypoint-initdb.d/01_init.sql;
      if [ -x /docker-entrypoint-initdb.d/02_seed_contactos.sh ]; then
        bash /docker-entrypoint-initdb.d/02_seed_contactos.sh;
      fi
      psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d "$POSTGRES_DB"
        -f /docker-entrypoint-initdb.d/02_validate_state.sql;
      psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d "$POSTGRES_DB"
        -f /docker-entrypoint-initdb.d/03_modelo_normalizado_contactos.sql;
      echo "[db_bootstrap] OK â€” 01/02/validate/03 completados"
    '
  restart: "no"
  profiles: ["ops"]
